<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport"content="width=device-width, initial-scale=1.0"/>
		<title>Magic Cookies</title>
		<link rel="stylesheet" href="../static/css/index.css" />
        <link rel="stylesheet" href="../static/css/galletas.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <script src="../static/js/carrito.js"></script>
        <meta name="csrf-token" content="{{ csrf_token() }}">

    </head>
	<body>
		<header>
			<div class="container-hero">
				<div class="container hero">
					<div class="container-logo">
						<img src="{{ url_for('static', filename='img/logo4sinfondo.png') }}" alt="logo">
						<h1 class="logo"><a href="/">MAGIC COOKIES</a></h1>
					</div>

					<div class="container-user">
						{% if current_user.is_authenticated %}
						<div class="user-dropdown" id="userDropdown">
								<span class="name">{{ current_user.nombre }} {{ current_user.apellido }} <i class="fa-solid fa-chevron-down"></i></span>
								<i class="fa-solid fa-user"></i>
								<div class="dropdown-content">
									<a href="/carrito/mis-pedidos">Mis pedidos</a>  
									<a href="/logout">Cerrar sesión</a>
								</div>
							</div>
						{% else %}
							<span class="text" onclick="window.location.href='/login'">Iniciar sesión o crear cuenta</span>
							<i class="fa-solid fa-user"></i>
						{% endif %}
						<i class="fa-solid fa-basket-shopping"></i>
						<div class="content-shopping-cart">
							<span class="text" onclick="window.location.href='/carrito/carrito'">Carrito</span>
							<span class="number">(0)</span>
						</div>
					</div>
				</div>
			</div>

			<div class="container-navbar">
				<nav class="navbar container">
					<i class="fa-solid fa-bars"></i>
                    <ul class="menu">
                        <li><a href="/">Inicio</a></li>
                        <li><a href="/carrito/galletas">Galletas</a></li>
                        <li><a href="/carrito/sobre_nosotros">Sobre nosotros</a></li>
                        <li><a href="/carrito/ubicacion">Ubicación</a></li>
                    </ul>
					<br>
					<br>
					<br>
				</nav>
			</div>
		</header>

		<section class="container products-section">
            <h1 class="heading-1">Nuestros Productos</h1>
        
            <div class="product-grid">
                {% for producto in productos %}
                <div class="product-card"
                    data-product-id="{{ producto.idProducto }}"
                    data-peso="{{ producto.peso }}">
        
                    <div class="product-image">
                        {% if producto.imagen %}
                        <img src="{{ url_for('static', filename='imagenes_productos/' + producto.imagen) }}" alt="{{ producto.nombre }}">
                        {% endif %}
                    </div>
                    
                    <div class="content-card-product">
                        <div class="stars"></div>
                        <h3>{{ producto.nombre }}</h3>
        
                        <div class="product-presentations">
                            <label for="presentation">Presentación:</label>
                            <select class="presentation-select">
                                {% for presentacion in producto.presentaciones %}
                                {% set tipo_mostrar = presentacion.tipo %}
                                {% if presentacion.tipo == 'Pre-empaçada 700 gr' %}
                                    {% set tipo_mostrar = '700g' %}
                                {% elif presentacion.tipo == 'Pre-empaçada 1Kg' %}
                                    {% set tipo_mostrar = '1kg' %}
                                {% endif %}
                                <option value="{{ tipo_mostrar }}" 
                                        data-precio="{{ presentacion.precio }}"
                                        data-tipo-original="{{ presentacion.tipo }}">
                                    {{ presentacion.tipo }} - ${{ "%.2f"|format(presentacion.precio) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
        
                        <div class="product-quantity">
                            <label class="quantity-label" for="quantity">Cantidad:</label>
                            <input type="number" class="quantity-input" min="1" value="1">
                        </div>
        
                        <div class="product-actions">
                            <button class="btn-add-to-cart">
                                <i class="fas fa-shopping-cart"></i> Añadir al carrito
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        

		<script>
            document.addEventListener('DOMContentLoaded', function() {
    // Función para verificar sesión
    async function checkSession() {
        try {
            const response = await fetch('/carrito/check-session');
            return await response.json();
        } catch (error) {
            console.error('Error al verificar sesión:', error);
            return { isLoggedIn: false, loginUrl: '/auth/login' };
        }
    }

    // Función para mostrar notificaciones
    function showNotification(message, isError = false) {
        const notification = document.createElement('div');
        notification.className = `notification ${isError ? 'error' : 'success'}`;
        notification.innerHTML = `
            <i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    // Función para mostrar alerta de login requerido
    function showLoginAlert(loginUrl) {
        const notification = document.createElement('div');
        notification.className = 'notification error';
        notification.innerHTML = `
            <i class="fas fa-sign-in-alt"></i>
            <span>Debes iniciar sesión para agregar productos</span>
        `;
        document.body.appendChild(notification);
        
        // Hacer la notificación clickeable para redirigir
        notification.style.cursor = 'pointer';
        notification.addEventListener('click', () => {
            window.location.href = loginUrl;
        });
        
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    // Función para actualizar el contador del carrito
    async function updateCartCounter() {
        try {
            const response = await fetch('/carrito/carrito-count');
            if (response.ok) {
                const data = await response.json();
                document.querySelectorAll('.content-shopping-cart .number').forEach(el => {
                    el.textContent = `(${data.count || 0})`;
                });
            }
        } catch (error) {
            console.error('Error al actualizar contador:', error);
        }
    }

    // Función para calcular precio según presentación
    function calcularPrecio(producto, presentacion) {
        const selectedOption = producto.querySelector(`.presentation-select option[value="${presentacion}"]`);
        return parseFloat(selectedOption.dataset.precio);
    }

    // Manejador para agregar al carrito
    async function handleAddToCart(e) {
        e.preventDefault();
        
        try {
            // Verificar sesión
            const sessionCheck = await fetch('/carrito/check-session');
            const sessionData = await sessionCheck.json();
            if (!sessionData.isLoggedIn) {
                showLoginAlert(sessionData.loginUrl);
                return;
            }

            const productCard = e.target.closest('.product-card');
            const productId = productCard.dataset.productId;
            const productName = productCard.querySelector('h3').textContent;
            
            const selectElement = productCard.querySelector('.presentation-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            // Obtener los valores necesarios
            const presentation = selectedOption.dataset.tipoOriginal;
            const quantity = parseInt(productCard.querySelector('.quantity-input').value);
            const price = parseFloat(selectedOption.dataset.precio);

            // Validar cantidad
            if (isNaN(quantity) || quantity < 1) {
                throw new Error('La cantidad debe ser al menos 1');
            }

            // Validar precio
            if (isNaN(price)) {
                throw new Error('Precio no válido');
            }

            // Enviar datos al servidor
            const response = await fetch(`/carrito/agregar/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    presentacion: presentation,
                    cantidad: quantity,
                    precio: price
                })
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Error al agregar al carrito');
            }

            if (result.success) {
                showNotification(`${productName} agregado al carrito`);
                await updateCartCounter();
            } else {
                throw new Error(result.error || 'Error al agregar al carrito');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification(error.message, true);
        }
    }

    // Configurar eventos
    function setupEventListeners() {
        document.querySelectorAll('.btn-add-to-cart').forEach(button => {
            button.addEventListener('click', handleAddToCart);
        });
        
        // Actualizar precios cuando cambia la presentación
        document.querySelectorAll('.presentation-select').forEach(select => {
            select.addEventListener('change', function() {
                const productCard = this.closest('.product-card');
                const precio = calcularPrecio(productCard, this.value);
                const option = this.options[this.selectedIndex];
                option.text = `${this.value} - $${precio.toFixed(2)}`;
            });
        });
    }

    // Control del menú desplegable del usuario
    const dropdown = document.querySelector(".user-dropdown");
    let dropdownTimeout;
    
    if (dropdown) {
        const dropdownContent = dropdown.querySelector(".dropdown-content");
        
        // Asegurarse que el menú esté oculto inicialmente
        dropdownContent.style.display = "none";
        
        dropdown.addEventListener("mouseenter", () => {
            clearTimeout(dropdownTimeout);
            dropdownContent.style.display = "block";
        });
        
        dropdown.addEventListener("mouseleave", () => {
            dropdownTimeout = setTimeout(() => {
                dropdownContent.style.display = "none";
            }, 300);
        });
        
        // Evitar que se cierre cuando el mouse está sobre el menú
        dropdownContent.addEventListener("mouseenter", () => {
            clearTimeout(dropdownTimeout);
        });
        
        dropdownContent.addEventListener("mouseleave", () => {
            dropdownContent.style.display = "none";
        });
    }

    // Inicializar
    setupEventListeners();
    updateCartCounter();
});
            </script>
    
	</body>
</html>